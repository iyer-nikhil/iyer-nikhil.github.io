function getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function pad(e,t){for("number"==typeof e&&(e+="");e.length<t;)e="0"+e;return e}$=document.querySelector.bind(document),window.render=function(e,t){const n="var p=[];with(this){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');";return new Function(n).apply(t)};var CustomDialog=function(){function e(e){this.parent="string"==typeof e?document.querySelector(e):e,this.dialog=this.parent.querySelector(".weui-dialog"),this.mask=this.parent.querySelector(".weui-mask")}return e.prototype.removeListener=function(e){var t=this;["animationend","webkitAnimationEnd"].forEach(function(n){t.dialog.removeEventListener(n,e)})},e.prototype.show=function(e){var t=this,n=this,i=function(t){n.removeListener(i),e&&e()};["animationend","webkitAnimationEnd"].forEach(function(e){t.dialog.addEventListener(e,i)}),this.parent.addEventListener("click",function(){t.hide()}),this.dialog.addEventListener("click",function(e){e.stopPropagation()}),this.parent.classList.remove("hidden"),this.dialog.classList.remove("weui-animate-fade-out"),this.dialog.classList.add("weui-animate-fade-in"),this.mask.classList.remove("weui-animate-fade-out"),this.mask.classList.add("weui-animate-fade-in")},e.prototype.hide=function(e){var t=this;this.dialog.classList.add("weui-animate-fade-out"),this.dialog.classList.remove("weui-animate-fade-in"),this.mask.classList.add("weui-animate-fade-out"),this.mask.classList.remove("weui-animate-fade-in");var n=this.parent,i=this,o=function(t){n.classList.add("hidden"),i.removeListener(o),e&&e()};["animationend","webkitAnimationEnd"].forEach(function(e){t.dialog.addEventListener(e,o)})},e}();Api={domain:apiRoot,token:oauth&&oauth.oauthid,get:function(e,t){return reqwest({url:this.domain+"sharecontents/"+e+"?token="+this.token,method:"GET",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})},list:function(e,t,n,i){return reqwest({url:this.domain+"sharecontents/"+e+"/comments?token="+this.token+"&offset="+t+"&limit="+n,method:"GET",success:function(e){i&&i(!0,e.data)},error:function(e){i&&i(!1,JSON.parse(e.response))}})},post:function(e,t,n,i){var o=this.domain+"sharecontents/"+e+"/comments?token="+this.token;return i&&(o=this.domain+"comments/"+e+"/reply?token="+this.token),reqwest({url:o,method:"POST",contentType:"application/json",data:JSON.stringify({comment:{content:t}}),success:function(e){n&&n(!0,e.data)},error:function(e){n&&n(!1,JSON.parse(e.response))}})},like:function(e,t){return reqwest({url:this.domain+"sharecontents/"+e+"/like?token="+this.token,method:"POST",contentType:"application/json",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})},likeComment:function(e,t){return reqwest({url:this.domain+"comments/"+e+"/like?token="+this.token,method:"POST",contentType:"application/json",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})},dislike:function(e,t){return reqwest({url:this.domain+"sharecontents/"+e+"/hate?token="+this.token,method:"POST",contentType:"application/json",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})},dislikeComment:function(e,t){return reqwest({url:this.domain+"comments/"+e+"/dislike?token="+this.token,method:"POST",contentType:"application/json",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})},updateReviewStatus:function(e,t,n){return reqwest({url:this.domain+"comments/"+e+"?token="+this.token,method:"POST",contentType:"application/json",data:JSON.stringify({comment:{status:t}}),success:function(e){n&&n(!0,e.data)},error:function(e){n&&n(!1,JSON.parse(e.response))}})},deleteComment:function(e,t){return reqwest({url:this.domain+"comments/"+e+"?token="+this.token,method:"DELETE",success:function(e){t&&t(!0,e.data)},error:function(e){t&&t(!1,JSON.parse(e.response))}})}},ready(function(){Origami.fastclick(document.body);var e=new function(){this.dialog=new CustomDialog(".popup"),this.parent=this.dialog.parent,this.input=$(".dialog textarea"),this.count=$(".dialog .count");var e=this;this.showCb=null,forEach(["change","keyup","paste"],function(t){e.input.addEventListener(t,function(t){"paste"===t.type&&t.preventDefault(),e.count.innerText=140-e.input.value.length})}),this.parent.querySelector(".opts div:last-child").addEventListener("click",function(t){e.showCb&&e.showCb(!0,e.input.value),e.hide()}),this.parent.querySelector(".opts div:first-child").addEventListener("click",function(t){e.showCb&&e.showCb(!1,null),e.hide()}),this.show=function(t,n){e.dialog.parent.querySelector(".reply-name span").innerText=t,e.input.value="",e.showCb=n,e.dialog.show(function(){e.input.focus(),e.input.click(),setTimeout(function(){e.input.focus(),e.input.click()},100)})},this.hide=function(t){e.dialog.hide(t)}},t=$("textarea");t.addEventListener("keyup",function(){var e=null;return t._onkeyup=function(){var n=t;n.style.height="1px",n.style.height=2+n.scrollHeight+"px",n.style.height!==e&&(e=n.style.height,document.body.scrollTop=document.body.scrollHeight)},function(e){t._onkeyup()}}());var n=getParameterByName("pid"),i=getParameterByName("action");(new Date).getTime()-parseInt(getParameterByName("actionTime"))>6e4&&(i=null),window.isAdmin=!1;var o=function(e,t){return!!oauth||(/micromessenger/.test(navigator.userAgent.toLowerCase())?(location.href=location.href+=(location.href.includes("?")?"&":"?")+"oauth_login=wechat&action="+e+"&cid="+t+"&actionTime="+(new Date).getTime(),!1):("LIKE"===e||"HATE"===e||"LIKE_COMMENT"===e?alert("非常抱歉，目前只能在微信端点赞。"):"COMMENT"===e&&alert("非常抱歉，目前只能在微信端评论。"),!1))},a=function(e){e=e.sharecontent,$(".actions .like span").innerText=e.like_user_count||0,$(".actions .dislike span").innerText=e.hate_user_count||0,e.like&&"LIKE"===e.like.action?($(".actions .like").classList.add("selected"),$(".actions .dislike").classList.remove("selected")):e.like&&"HATE"===e.like.action&&($(".actions .dislike").classList.add("selected"),$(".actions .like").classList.remove("selected")),$(".top span").innerText=e.comments_count||0},r={},s=function(){var e=$("#temp-cmt").innerHTML,t=$(".cms");return window.now=moment(),function(n,i){r[n.id]=n,n.like||(n.like={}),n.replies?forEach(n.replies,function(e){var t=moment(e.created_time);e.created_time_fmt=moment.duration(now.diff(t)).humanize()+"前"}):n.replies=[];var o=moment(n.created_time);n.created_time_fmt=moment.duration(now.diff(o)).humanize()+"前",i?i.outerHTML=render(e,n):t.insertAdjacentHTML("beforeEnd",render(e,n))}}();window.Actions={like:function(e){o("LIKE")&&(e.classList.contains("selected")||Api.like(n,function(e,t){a(t)}))},dislike:function(e){o("HATE")&&(e.classList.contains("selected")||Api.dislike(n,function(e,t){a(t)}))},likeComment:function(e){var t=e.getAttribute("data-cid");o("LIKE_COMMENT",t)&&(e.classList.contains("selected")?Api.dislikeComment(t,function(e,n){var i=$('[data-cid="'+t+'"]');i.classList.remove("selected"),i.querySelector("span").innerText=n.comment.like_user_count}):Api.likeComment(t,function(e,n){var i=$('.like[data-cid="'+t+'"]');i.classList.add("selected"),i.querySelector("span").innerText=n.comment.like_user_count}))},setStatus:function(e,t){var n=e.parentNode.parentNode.getAttribute("data-cid2");Api.updateReviewStatus(n,t,function(t,n){if(t){var i=e.parentNode.parentNode.parentNode.parentNode;s(n.comment,i)}})},deleteComment:function(e){var t=e.parentNode.parentNode,n=t.querySelector("[data-cid2]").getAttribute("data-cid2");weui.confirm("你确定删除这条评论吗？",function(){Api.deleteComment(n,function(e,n){if(!e)return void alert("删除失败");t.parentNode.parentNode.removeChild(t.parentNode)})})},reply:function(t){var n=t.parentNode.parentNode.parentNode,i=n.querySelector("[data-cid]").getAttribute("data-cid");e.show(n.querySelector(".name").innerText,function(e,t){e&&Api.post(i,t,function(e,t){if(!e)return void weui.alert(t.errors[0].message);var o=r[i];o.replies.push(t.comment),o.replied_count++,s(o,n)},!0)})},replyReply:function(t){if(o()){var n=t.parentNode.parentNode,i=n.getAttribute("data-reply-id"),a=n.querySelector("p").innerText;e.show(a,function(e,t){e&&t&&Api.post(i,t,function(e,t){var i=n.parentNode.parentNode.parentNode,o=i.querySelector("[data-cid]").getAttribute("data-cid"),a=r[o];a.replies.unshift(t.comment),s(a,i)},!0)})}},likeReply:function(e){if(o()){var t=e.parentNode.getAttribute("data-reply-id");e.classList.contains("selected")?Api.dislikeComment(t,function(t,n){t&&(e.querySelector("span").innerText=n.comment.like_user_count,e.classList.remove("selected"))}):Api.likeComment(t,function(t,n){t&&(e.querySelector("span").innerText=n.comment.like_user_count,e.classList.add("selected"))})}},deleteReply:function(e){var t=e.parentNode.parentNode,n=t.getAttribute("data-reply-id"),i=t.parentNode.parentNode.parentNode,o=i.querySelector("[data-cid]").getAttribute("data-cid"),a=r[o],c=r[o].replies,u=null;forEach(c,function(e){e.id===n&&(u=e)}),u&&(isAdmin||u.creator.oauthid2===oauth.oauthid)&&weui.confirm("你确定删除这条回复吗？<br>"+t.querySelector("p:nth-child(2)").innerText,function(){Api.deleteComment(n,function(e,t){if(e){var n=c.indexOf(u);n<0||(c.splice(n,1),a.replied_count--,s(a,i))}})})}},Api.get(n,function(e,t){a(t),"LIKE"===i?$(".actions .like").click():"HATE"===i&&$(".actions .dislike").click(),Api.list(n,0,1e3,function(e,t){if(e){window.isAdmin=t.isAdmin;var n=t.comments;if(n.length>0)for(var o=0;o<n.length;o++)s(n[o]);else $(".empty").style.display="block";if("COMMENT"===i)document.body.scrollTop=document.body.scrollHeight;else if("LIKE_COMMENT"===i&&getParameterByName("cid")){var a=$('[data-cid="'+getParameterByName("cid")+'"]');a&&a.click()}}})}),$(".post .send").addEventListener("click",function(e){if(o("COMMENT")&&!e.target.posting){e.target.posting=!0;var i=t.value;i&&Api.post(n,i,function(n,i){if(!n)return weui.alert(i.errors[0].message),void(e.target.posting=!1);e.target.posting=!1,t.value="",t._onkeyup(),s(i.comment),$(".top span").innerText=1+~~$(".top span").innerText})}}),$(".post #content").addEventListener("click",function(e){o("COMMENT")}),$(".top .right").addEventListener("click",function(e){o("COMMENT")&&(document.body.scrollTop=document.body.scrollHeight,$(".post #content").focus())}),wxConfig&&(wxConfig.jsApiList=["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone"],wx.config(wxConfig),wx.ready(function(){for(var e=[wx.onMenuShareTimeline,wx.onMenuShareAppMessage,wx.onMenuShareQQ,wx.onMenuShareWeibo,wx.onMenuShareQZone],t={title:$("title").innerText,imgUrl:$(".sec1 img").src,desc:$("p.content").innerText,link:location.href},n=0;n<e.length;n++)e[n].bind(wx)(t)}))});